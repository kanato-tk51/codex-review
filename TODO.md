# TODO (codex-review)

> ゴール: ブラウザUIからの指示でローカルターミナル上の codex コマンドを安全に実行できる仕組みを提供する。

## P0: 最低限の安全なシェル実行経路
- [x] シェル実行APIの追加
  - `POST /api/shell/run`（仮）：ホワイトリスト化したコマンドのみ実行（例: `codex-review …`, `git status`, `pnpm run build`）。
  - 環境変数 `ENABLE_SHELL_API=true` がないと 403 を返す。
- [x] 出力ストリーム配信
  - SSE/WS で stdout/stderr をリアルタイム配信し、完了/失敗ステータスを通知。
  - 標準入力は受け付けない（コマンドは非対話）。
- [x] 認可・CSRF対策
  - トークンは使わず、同一オリジン制約 + 簡易CSRFトークンで防御。
  - レートリミットの最小実装（IP/オリジン単位）。
- [x] UI最小実装
  - 事前定義コマンドのプルダウン（自由入力なし）。
  - 実行ボタンとログビュー（ストリーミング表示）。
- [x] ドキュメント
  - 有効化方法（環境変数）、許可コマンド一覧、リスク説明、無効化手順を README に追記。

## P0: リポジトリ自動検出とブランチ選択UI
- [x] リポジトリスキャン（自動）
  - アプリ起動時に **ルート直下のみ** を走査し、`.git` を含むディレクトリ一覧を収集（サブディレクトリは対象外）。
  - `node_modules`, `.cache` など明示除外。ページ再読み込み時は毎回スキャンし直す（セッション内キャッシュのみ許容）。手動リフレッシュ API も用意。
- [x] リポジトリ取得（手動追加）
  - ルート直下以外のリポはユーザーにフォルダを選択してもらい手動追加するUIを用意。
  - フロントでディレクトリピッカーを開き、パスをバックエンドに送って登録するフローを追加。
- [x] ブランチ取得
  - バックエンドで各リポのブランチ一覧を事前取得し、APIで返却（git branch --format を想定）。
  - 取得失敗時のエラーもUIに表示できるようステータス込みで返す。
- [x] UI実装
  - 初期画面にリポ一覧（自動スキャン結果＋手動追加分）を表示し、選択するとブランチ選択モーダル/セクションへ遷移。
  - ブランチは事前ロード済みリストから選択式（再取得ボタン付き）。
  - 選択中のリポ/ブランチ状態をグローバルストア（React Query / Zustand など）で保持。
  - 「フォルダを選択して追加」ボタンを配置し、サブ階層リポを手動で取り込めるようにする。
  - リポ/ブランチ一覧にステータス列を設け、取得エラーを明示表示。
- [x] API設計
  - `GET /api/repos/auto`（ルート直下スキャン結果）
  - `POST /api/repos/auto/refresh`（再スキャン）
  - `POST /api/repos/manual`（手動追加: パスを受け取り登録）
  - `GET /api/repos/:id/branches`（キャッシュ済みブランチ一覧）
- [x] ドキュメント
  - スキャン対象ルートの指定方法（env `REPO_SCAN_ROOT`、未指定ならアプリ起動ディレクトリ）。
  - サブ階層リポは手動追加する運用であることを明記。
  - 除外パス/深さの設定方法、UIでのリフレッシュ手順。

## P1: 拡張と運用性
- [ ] コマンドテンプレートの追加/削除を設定ファイルで管理（再起動なしで反映）。
- [ ] 実行履歴の保存（ローカルDB）と UI 表示（成功/失敗・実行時刻・出力サマリ）。
- [ ] 詳細権限制御：コマンドごとのロール/トークン制御を設計。
- [ ] ログの長さ・保持期間・ダウンロード機能。

## P2: 信頼性・テスト
- [ ] シェル実行APIのユニット/統合テスト（モックプロセス）。
- [ ] SSE/WS のE2Eテスト（モックコマンドでログが流れること）。
- [ ] レートリミット/トークン認証のテスト。

## 既知の検討事項
- [ ] 完全非対話コマンドに制限するポリシーの維持方法。
- [ ] Windows/WSL/macOS でのコマンド互換性（パスやシェル差異）。
- [ ] 将来的に Electron/Tauri 化する際の再利用性。
